### BASE IMAGE
FROM node:lts-alpine@sha256:9a2db0008b592cfde1b98aa8972a8051ccb80bb51dde8b06c3a2e3762794e89c AS base

WORKDIR /app

# Update linux depenencies & install curl
RUN apk add && \
    apk add curl && \
    curl -sf https://gobinaries.com/tj/node-prune | sh

# Install dependencies
# Copy partial package.json generated by the NX build + package-lock.json
COPY ./dist/apps/transaction-service/package.json package-lock.json ./

# TODO: Remove explicit installation of mapped-types when NX generates package json correct again
RUN npm ci --no-audit --no-fund && run npm i @nestjs/mapped-types

# Copy built code
COPY ./dist/apps/transaction-service ./

# Prune unused files from node_modules folder
RUN node-prune


### FINAL IMAGE
FROM node:lts-alpine@sha256:9a2db0008b592cfde1b98aa8972a8051ccb80bb51dde8b06c3a2e3762794e89c

# Set up container environment
WORKDIR /app
ENV NODE_ENV=production

# Run application as node default user (instead of root)
RUN chown -R node:node /app
USER node

COPY --from=base /app ./

CMD node ./main.js
