# node:lts-slim
FROM node@sha256:ef9e0abfa1aa07d23cc51b69820885fc83f51c10fab463aec5a56f282dca744f

# Set up container environment
WORKDIR /app
ENV NODE_ENV=production

# Run application as node default user (instead of root)
RUN chown -R node:node /app
USER node

# Install dependencies
# Copy partial package.json generated by the NX build + package-lock.json
COPY ./dist/apps/auth-service/package.json package-lock.json ./

RUN npm ci --no-audit --no-fund

# Copy built code
COPY ./dist/apps/auth-service ./

# Run node prune
RUN apt update && \
    apt install curl && \
    curl -sf https://gobinaries.com/tj/node-prune | sh && \
    node-prune

CMD node ./main.js
